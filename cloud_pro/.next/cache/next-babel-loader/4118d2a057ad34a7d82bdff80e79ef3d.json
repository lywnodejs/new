{"ast":null,"code":"import \"antd/lib/space/style\";\nimport _Space from \"antd/lib/space\";\nimport \"antd/lib/radio/style\";\nimport _Radio from \"antd/lib/radio\";\nimport \"antd/lib/upload/style\";\nimport _Upload from \"antd/lib/upload\";\nimport \"antd/lib/select/style\";\nimport _Select from \"antd/lib/select\";\nimport \"antd/lib/card/style\";\nimport _Card from \"antd/lib/card\";\nimport \"antd/lib/button/style\";\nimport _Button from \"antd/lib/button\";\nimport \"antd/lib/modal/style\";\nimport _Modal from \"antd/lib/modal\";\nimport \"antd/lib/message/style\";\nimport _message from \"antd/lib/message\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport \"antd/lib/form/style\";\nimport _Form from \"antd/lib/form\";\nimport _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport { Layout } from '~/components/Layout';\nimport Router, { withRouter, useRouter } from 'next/router';\nimport React, { useState, useEffect } from 'react';\nimport styles from './index.less';\nimport TableList from './TableList';\nimport api from '~/api/dataUpdate';\nimport { constant, values } from 'lodash';\nimport { base64ToFileOrBlob } from 'web-downloadfile';\nimport { postForm, post } from '~/utils/fetch';\nimport { ExclamationCircleFilled } from '@ant-design/icons';\nvar breadcrumbs = [{\n  text: '乡村振兴'\n}, {\n  text: '数据更新'\n}];\nvar pageParams = {\n  pageNum: 1,\n  pageSize: 20\n};\nvar fileTypeList = [{\n  id: 11,\n  name: '人工调整信用分'\n}, {\n  id: 12,\n  name: '医保数据'\n}, {\n  id: 13,\n  name: '劳动力数据'\n}, {\n  id: 14,\n  name: '存款数据'\n}, {\n  id: 15,\n  name: '不良贷款数据'\n}, {\n  id: 16,\n  name: '存量贷款数据'\n}, {\n  id: 17,\n  name: '线下搜集数据'\n}];\nvar fileVertical = [{\n  id: 1,\n  name: '增量 (追加新数据，覆盖重复数据)'\n}, {\n  id: 2,\n  name: '全量 (请慎重选择，此方式将删除所有同类别旧数据)'\n}];\n\nfunction body(props) {\n  //获取个人数据上传记录\n  var _useState = useState([]),\n      list = _useState[0],\n      setList = _useState[1];\n\n  var _useState2 = useState([]),\n      totalData = _useState2[0],\n      setTotalData = _useState2[1];\n\n  var _useState3 = useState(false),\n      isModalVisible = _useState3[0],\n      setIsModalVisible = _useState3[1];\n\n  var _useState4 = useState([]),\n      fileList = _useState4[0],\n      setFileList = _useState4[1];\n\n  var _Form$useForm = _Form.useForm(),\n      _Form$useForm2 = _slicedToArray(_Form$useForm, 1),\n      form = _Form$useForm2[0];\n\n  var _useState5 = useState(false),\n      loading = _useState5[0],\n      setLoading = _useState5[1];\n\n  var router = useRouter();\n\n  var _useState6 = useState(false),\n      onModalVisible = _useState6[0],\n      setOnModalVisible = _useState6[1];\n\n  var _useState7 = useState({}),\n      valuesForm = _useState7[0],\n      setValueForm = _useState7[1];\n\n  var _useState8 = useState({}),\n      valuesTestFile = _useState8[0],\n      setValuesTestFile = _useState8[1];\n\n  var _useState9 = useState(11),\n      fileTypeId = _useState9[0],\n      setFileTypeId = _useState9[1];\n\n  var _useState10 = useState(11),\n      fileTemplate = _useState10[0],\n      setFileTemplate = _useState10[1];\n\n  var showModal = function showModal() {\n    setIsModalVisible(true);\n  };\n\n  useEffect(function () {\n    fetchList(); // onSearch()\n    // onRescore()\n  }, []); //下载模板\n\n  var onDownLoad = /*#__PURE__*/function () {\n    var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      var _yield$api$fetch_down, _yield$api$fetch_down2, data, code, linkElement;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.prev = 0;\n              _context.next = 3;\n              return api.fetch_downloadTemplate_list({});\n\n            case 3:\n              _yield$api$fetch_down = _context.sent;\n              _yield$api$fetch_down2 = _yield$api$fetch_down.data;\n              data = _yield$api$fetch_down2.data;\n              code = _yield$api$fetch_down2.code;\n\n              if (code == 0) {\n                linkElement = document.createElement('a');\n                linkElement.style.display = 'none';\n                linkElement.href = data;\n                document.body.appendChild(linkElement);\n                linkElement.click();\n                document.body.removeChild(linkElement);\n                console.log(data);\n                base64ToFileOrBlob('data:wKgc4WDMQI6AOn16AAC22lK3WwU732/zip;base64,' + data.pdfData);\n              }\n\n              _context.next = 13;\n              break;\n\n            case 10:\n              _context.prev = 10;\n              _context.t0 = _context[\"catch\"](0);\n              console.log(_context.t0);\n\n            case 13:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, null, [[0, 10]]);\n    }));\n\n    return function onDownLoad() {\n      return _ref.apply(this, arguments);\n    };\n  }(); //获取个人数据上传记录\n\n\n  var fetchList = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var values,\n          _yield$api$fetch_uplo,\n          _yield$api$fetch_uplo2,\n          data,\n          code,\n          _args2 = arguments;\n\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              values = _args2.length > 0 && _args2[0] !== undefined ? _args2[0] : {};\n              _context2.prev = 1;\n              _context2.next = 4;\n              return api.fetch_uploadRecord_list(_objectSpread(_objectSpread({}, pageParams), values));\n\n            case 4:\n              _yield$api$fetch_uplo = _context2.sent;\n              _yield$api$fetch_uplo2 = _yield$api$fetch_uplo.data;\n              data = _yield$api$fetch_uplo2.data;\n              code = _yield$api$fetch_uplo2.code;\n\n              if (code === 0) {\n                data.list.forEach(function (item) {\n                  item.uploadSuccNum = item.uploadSuccNum || '-';\n                  item.uploadFailNum = item.uploadFailNum || '-';\n                  item.scoreSuccNum = item.scoreSuccNum || '-';\n                  item.scoreFailNum = item.scoreFailNum || '-';\n                });\n                setList(data.list);\n                setTotalData(data);\n              }\n\n              _context2.next = 14;\n              break;\n\n            case 11:\n              _context2.prev = 11;\n              _context2.t0 = _context2[\"catch\"](1);\n              console.log(_context2.t0);\n\n            case 14:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[1, 11]]);\n    }));\n\n    return function fetchList() {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var onBeforeUpload = function onBeforeUpload() {\n    return false;\n  };\n\n  var onChangeUpload = function onChangeUpload(info) {\n    var files = _toConsumableArray(info.fileList);\n\n    files = files.slice(-1);\n    setFileList(files);\n  };\n\n  var onCancel = function onCancel() {\n    form.resetFields();\n    setFileList([]);\n    setIsModalVisible(false);\n  };\n\n  var onUpload = function onUpload(values) {\n    console.log(values);\n    values.testFile = values.testFile.file;\n\n    if (isMac()) {\n      var fileType = values.testFile.name.endsWith('.xlsx') || values.testFile.name.endsWith('.xls');\n\n      if (!fileType) {\n        _message.warning('只能上传excel文件！请重新选择');\n\n        return;\n      }\n    }\n\n    setValueForm(values);\n    setValuesTestFile(values.testFile);\n    setOnModalVisible(true);\n  };\n\n  var onConfirmUpload = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n      var _yield$postForm, code;\n\n      return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              setLoading(true);\n              _context3.prev = 1;\n              _context3.next = 4;\n              return postForm('core/rural/upload', valuesForm);\n\n            case 4:\n              _yield$postForm = _context3.sent;\n              code = _yield$postForm.data.code;\n\n              if (code === 0) {\n                onCancel();\n              }\n\n              _context3.next = 12;\n              break;\n\n            case 9:\n              _context3.prev = 9;\n              _context3.t0 = _context3[\"catch\"](1);\n              console.log(_context3.t0);\n\n            case 12:\n              setOnModalVisible(false);\n              setLoading(false);\n\n            case 14:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, _callee3, null, [[1, 9]]);\n    }));\n\n    return function onConfirmUpload() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  var isMac = function isMac() {\n    if (typeof navigator !== 'undefined') {\n      return /macintosh|mac os x/i.test(navigator.userAgent);\n    }\n\n    return false;\n  };\n\n  var onSearch = /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(value) {\n      return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              pageParams.pageNum = 1;\n              fetchList(_objectSpread({}, values));\n\n            case 2:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, _callee4);\n    }));\n\n    return function onSearch(_x) {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  var onPage = /*#__PURE__*/function () {\n    var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5() {\n      return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n        while (1) {\n          switch (_context5.prev = _context5.next) {\n            case 0:\n              fetchList(values);\n\n            case 1:\n            case \"end\":\n              return _context5.stop();\n          }\n        }\n      }, _callee5);\n    }));\n\n    return function onPage() {\n      return _ref5.apply(this, arguments);\n    };\n  }(); //重新评分\n\n\n  var onFail = /*#__PURE__*/function () {\n    var _ref6 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(record) {\n      return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n        while (1) {\n          switch (_context6.prev = _context6.next) {\n            case 0:\n              console.log(record);\n\n              _Modal.confirm({\n                title: '下载失败的数据',\n                onOk: function onOk() {\n                  return new Promise(function (resolve, reject) {\n                    post('core/rural/rescore', {\n                      recordId: record.uploadFailNum\n                    }).then(function (_ref7) {\n                      var _ref7$data = _ref7.data,\n                          data = _ref7$data.data,\n                          code = _ref7$data.code;\n\n                      if (code === 0) {\n                        var linkElement = document.createElement('a');\n                        linkElement.style.display = 'none';\n                        linkElement.href = 'https://test-oss.xysl.com/group1/M00/01/68/wKgc4WDRjCGAMYJaAABoALb4cjY950.xls';\n                        document.body.appendChild(linkElement);\n                        linkElement.click();\n                        document.body.removeChild(linkElement);\n                        console.log(data);\n                        resolve();\n\n                        _message.success('下载成功');\n\n                        console.log(record.uploadFailNum);\n                      }\n\n                      reject();\n                    });\n                  })[\"catch\"](function () {\n                    return console.log('Oops errors!');\n                  });\n                }\n              });\n\n            case 2:\n            case \"end\":\n              return _context6.stop();\n          }\n        }\n      }, _callee6);\n    }));\n\n    return function onFail(_x2) {\n      return _ref6.apply(this, arguments);\n    };\n  }();\n\n  var onScore = /*#__PURE__*/function () {\n    var _ref8 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(record) {\n      return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n        while (1) {\n          switch (_context7.prev = _context7.next) {\n            case 0:\n              console.log(record);\n\n              _Modal.confirm({\n                title: '确定重新评分？',\n                onOk: function onOk() {\n                  return new Promise(function (resolve, reject) {\n                    post('core/rural/rescore', {\n                      recordId: record.id\n                    }).then(function (_ref9) {\n                      var _ref9$data = _ref9.data,\n                          data = _ref9$data.data,\n                          code = _ref9$data.code;\n\n                      if (code === 0) {\n                        resolve();\n\n                        _message.success('提交成功');\n                      }\n\n                      reject();\n                    });\n                  })[\"catch\"](function () {\n                    return console.log('Oops errors!');\n                  });\n                }\n              });\n\n            case 2:\n            case \"end\":\n              return _context7.stop();\n          }\n        }\n      }, _callee7);\n    }));\n\n    return function onScore(_x3) {\n      return _ref8.apply(this, arguments);\n    };\n  }();\n\n  var getFileTypeList = function getFileTypeList() {\n    var a = fileTypeList.find(function (item) {\n      return item.id === valuesForm.fileType;\n    });\n\n    if (a) {\n      return a.name;\n    }\n  };\n\n  var getHandleType = function getHandleType() {\n    var a = fileVertical.find(function (item) {\n      return item.id === valuesForm.handleType;\n    });\n\n    if (a) {\n      return a.name;\n    }\n  };\n\n  var fileTypeChange = function fileTypeChange(val) {\n    setFileTypeId(val);\n    setFileTemplate(val);\n  };\n\n  return __jsx(React.Fragment, null, __jsx(Layout, {\n    breadcrumbs: breadcrumbs\n  }, __jsx(_Card, {\n    style: {\n      marginBottom: 30\n    }\n  }, __jsx(_Form, null, __jsx(_Button, {\n    type: \"primary\",\n    style: {\n      width: 120,\n      borderRadius: 5\n    },\n    onClick: showModal\n  }, \"\\u5BFC\\u5165\\u6570\\u636E\"), __jsx(\"u\", {\n    className: styles.item,\n    id: \"a\",\n    onClick: onDownLoad\n  }, \"\\u4E0B\\u8F7D\\u6A21\\u677F\"))), __jsx(TableList, {\n    list: list,\n    setList: setList,\n    totalData: totalData,\n    pageParams: pageParams,\n    onPage: onPage,\n    onSearch: onSearch,\n    values: values,\n    onScore: onScore,\n    onFail: onFail\n  })), __jsx(_Space, {\n    direction: \"vertical\",\n    size: \"large\",\n    style: {\n      width: '100%'\n    }\n  }, __jsx(_Form, {\n    layout: \"inline\",\n    className: \"searchForm\",\n    initialValues: {\n      fileType: '',\n      testFile: '',\n      handleType: '',\n      name: '0'\n    },\n    form: form,\n    onFinish: onUpload\n  }, __jsx(_Modal, {\n    title: \"\\u5BFC\\u5165\\u6570\\u636E\",\n    visible: isModalVisible,\n    onOk: function onOk() {\n      form.submit();\n    },\n    okText: \"\\u7EE7\\u7EED\",\n    onCancel: onCancel\n  }, __jsx(\"div\", {\n    style: {\n      display: 'flex'\n    }\n  }, __jsx(_Form.Item, {\n    label: \"\\u6570\\u636E\\u7C7B\\u522B\",\n    name: \"name\",\n    rules: [{\n      required: true\n    }]\n  }, __jsx(_Select, {\n    style: {\n      width: '130px'\n    }\n  }, __jsx(_Select.Option, {\n    value: \"0\"\n  }, \"\\u4E2A\\u4EBA\"))), __jsx(_Form.Item, {\n    name: \"fileType\",\n    rules: [{\n      required: true,\n      message: '请选择数据类别'\n    }]\n  }, __jsx(_Select, {\n    style: {\n      width: '130px',\n      marginLeft: '10px'\n    },\n    onChange: function onChange(val) {\n      return fileTypeChange(val);\n    }\n  }, __jsx(_Select.Option, {\n    value: \"\"\n  }, \"\\u8BF7\\u9009\\u62E9\"), fileTypeList.map(function (item) {\n    return __jsx(_Select.Option, {\n      value: item.id,\n      key: item.id\n    }, item.name);\n  })))), __jsx(_Form.Item, {\n    label: \"\\u6570\\u636E\\u6587\\u4EF6\",\n    name: \"testFile\",\n    rules: [{\n      required: true,\n      message: '请上传文件'\n    }]\n  }, __jsx(_Upload, {\n    beforeUpload: onBeforeUpload,\n    onChange: onChangeUpload,\n    showUploadList: {\n      showRemoveIcon: false\n    },\n    fileList: fileList,\n    accept: isMac() ? '' : 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel'\n  }, __jsx(_Button, {\n    style: {\n      width: '130px'\n    }\n  }, \"\\u4E0A\\u4F20\\u6587\\u4EF6\"))), fileTypeId !== 11 && __jsx(_Form.Item, {\n    label: \"\\u5BFC\\u5165\\u6A21\\u5F0F\",\n    name: \"handleType\",\n    rules: [{\n      required: true,\n      message: '请选择导入模式'\n    }]\n  }, __jsx(_Radio.Group, null, __jsx(_Space, {\n    direction: \"vertical\"\n  }, fileVertical.map(function (item) {\n    return __jsx(_Radio, {\n      value: item.id,\n      key: item.id\n    }, item.name);\n  })))))), __jsx(_Modal, {\n    visible: onModalVisible,\n    onOk: onConfirmUpload,\n    onCancel: function onCancel() {\n      setOnModalVisible(false);\n    },\n    closeIcon: true,\n    confirmLoading: loading\n  }, __jsx(\"div\", {\n    style: {\n      display: 'flex'\n    }\n  }, __jsx(ExclamationCircleFilled, {\n    style: {\n      color: 'rgb(250, 173, 20)',\n      fontSize: '24px'\n    }\n  }), __jsx(\"p\", {\n    style: {\n      marginLeft: '10px',\n      fontSize: '16px'\n    }\n  }, \"\\u8BF7\\u786E\\u8BA4\\u4EE5\\u4E0B\\u4FE1\\u606F\")), __jsx(\"div\", null, __jsx(\"div\", {\n    className: styles.upData\n  }, __jsx(\"span\", null, \"\\u6570\\u636E\\u7C7B\\u522B:\"), __jsx(\"span\", null, \"\\u4E2A\\u4EBA-\", getFileTypeList())), __jsx(\"div\", {\n    className: styles.upData\n  }, __jsx(\"span\", null, \"\\u6570\\u636E\\u6587\\u4EF6:\"), __jsx(\"span\", null, valuesTestFile.name)), fileTemplate !== 11 && __jsx(\"div\", {\n    className: styles.upData\n  }, __jsx(\"span\", null, \"\\u5BFC\\u5165\\u6A21\\u5F0F:\"), __jsx(\"span\", null, getHandleType()))))));\n}\n\nbody.getInitialProps = /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee8() {\n  return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n    while (1) {\n      switch (_context8.prev = _context8.next) {\n        case 0:\n          return _context8.abrupt(\"return\", {});\n\n        case 1:\n        case \"end\":\n          return _context8.stop();\n      }\n    }\n  }, _callee8);\n}));\nexport default body;","map":null,"metadata":{},"sourceType":"module"}