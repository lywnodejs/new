<template>
    <div>
        <div class="detail" id="knowledge-detail"
      v-show="!loading">
        <div class="detailTitle">
            {{vulKnowledgeDetail.vul_knowledge_name}}
        </div>
        <!-- <h1></h1> -->
        <div class="summary" >
            <div class="subTitle">概要</div>
            <!-- <h3>概要</h3> -->
            <div class="flex">
                <div class="item">漏洞等级：<el-tag :class="classColor">{{vulKnowledgeDetail.vul_level_id}}</el-tag></div>
                <div class="item">语言：{{vulKnowledgeDetail.vul_language}}</div>
                <div class="item">平台：{{vulKnowledgeDetail.vul_platform}}</div>
            </div>
            <div class="flex">
                <div class="item">CVSS评分：{{vulKnowledgeDetail.vul_cvss}}</div>
                <div class="item">capec：<a :href='capeclink' target="_blank">{{vulKnowledgeDetail.vul_capec}}</a></div>
                <div class="item">CWE：<a :href='CWElink' target="_blank">{{vulKnowledgeDetail.vul_cwe}}</a></div>
            </div>
            <div class="subTitle">漏洞描述</div>
            <!-- <h3>漏洞描述</h3> -->
            <div class="flex">
                <mavon-editor class="displayNone" v-model="vulKnowledgeDetail.vul_description" @change="change"></mavon-editor>
                <div class="item" v-html="vulKnowledgeDetail.vul_description"></div>
            </div>
            <div class="subTitle">漏洞危害</div>
            <!-- <h3>漏洞危害</h3> -->
            <div class="flex">
                <mavon-editor class="displayNone" v-model="vulKnowledgeDetail.vul_harmfulness" @change="change"></mavon-editor>
                <div class="item" v-html="vulKnowledgeDetail.vul_harmfulness"></div>
            </div>
            <div class="subTitle">修复建议</div>
            <!-- <h3>修复建议</h3> -->
            <div class="flex">
                <mavon-editor class="displayNone" style='display:none' v-model="vulKnowledgeDetail.vul_fix_suggestion" @change="change"></mavon-editor>
                <div class="item" v-html="vulKnowledgeDetail.vul_fix_suggestion"></div>
            </div>
        </div>
      </div>
      <div v-show="loading" 
           v-loading="loading"
           class="knowledge-loading"
           element-loading-text="拼命加载中"></div>

    </div>
    
</template>
<script>
import { connect } from '@/lib'
import { mavonEditor } from 'mavon-editor'
import 'mavon-editor/dist/css/index.css'

export default connect(() => {
  return {

      vulKnowledgeDetail: 'dolphin/vulKnowledgeDetail'
  }
}, {
  getVulKnowledgeDetail: 'dolphin/getVulKnowledgeDetail'
})({
    name: 'knowledge-detail',
    data() {
        return {
            detailData: {vul_level_idName: ''},
            classColor: '',
            capeclink: 'https://capec.mitre.org/data/definitions/1000.html',
            CWElink: 'https://cwe.mitre.org/data/definitions/681.html',
            loading: true
        }
    },
    components: { mavonEditor },
    created() {
        this.fetchData()
    },
    mounted() {
    },
    methods: {
        fetchData() {
          let queryParams = {
            page: 1,
            limit: 10,
            keywords: {vul_knowledge_id: this.$route.query.knowledgeId}
          }
          let param = {queryParam: queryParams}
            this.getVulKnowledgeDetail(param).then(res => {
                if (this.vulKnowledgeDetail.vul_level_id == 0) {
                    this.vulKnowledgeDetail.vul_level_id = '严重(S0)'
                    this.classColor = 'color1'
                } else if (this.vulKnowledgeDetail.vul_level_id == 1) {
                    this.vulKnowledgeDetail.vul_level_id = '高危(S1)'
                    this.classColor = 'color2'
                } else if (this.vulKnowledgeDetail.vul_level_id == 2) {
                    this.vulKnowledgeDetail.vul_level_id = '中危(S2)'
                    this.classColor = 'color3'
                } else if (this.vulKnowledgeDetail.vul_level_id == 3) {
                    this.vulKnowledgeDetail.vul_level_id = '低危(S3)'
                    this.classColor = 'color4'
                }
                this.capeclink = 'https://capec.mitre.org/data/definitions/' + this.vulKnowledgeDetail.vul_capec + '.html'
                this.CWElink = 'https://cwe.mitre.org/data/definitions/' + this.vulKnowledgeDetail.vul_cwe + '.html'

                this.vulKnowledgeDetail.vul_description = this.transform(this.vulKnowledgeDetail.vul_description)
                this.vulKnowledgeDetail.vul_harmfulness = this.transform(this.vulKnowledgeDetail.vul_harmfulness)
                this.vulKnowledgeDetail.vul_fix_suggestion = this.transform(this.vulKnowledgeDetail.vul_fix_suggestion)
                this.loading = false
            })
        },
        change(bol, str) {
        },
        transform(s) {
            let md = mavonEditor.getMarkdownIt()
            let preview = md.render(String(s))

            // console.log(mavonEditor.getMarkdownIt().use(mihe))
            return preview
        }
    }
})
</script>
<style lang="less" scoped>
.detail{
    width: 100%;
    box-sizing: border-box;
    background: white;
    -webkit-font-smoothing: antialiased; 
    // margin-top: -15px;
    // padding: 20px;
    // margin-bottom: 15px;
    .detailTitle{
        margin-top: 5px;
        font-size: 18px;
        // font-weight: 500;
    }
    .displayNone{
        display: none;
    }
    .summary{
        margin: 20px 0;
        .subTitle {
            margin-top: 30px;
            font-size: 14px;
        }
        .flex{
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
            margin-left: 10px;
            margin-right: 10px;
            .item{
                flex: 1;
                width: 100%;
                color: #757575;
                word-wrap:break-word;
                word-break:break-all;
                font-size: 13px;
                a{
                    text-decoration: underline;
                    color: #FC9153;
                    word-wrap:break-word;
                    word-break:break-all;
                }
                .color1{
                    background: white;
                    border:1px solid rgb(190, 7, 18);
                    height: 18px;
                    width: 50px;
                    padding: 1px;
                    padding-top: -4px; 
                    line-height: 15px;
                    color: rgb(190, 7, 18);
                    // font-weight: 400;
                }
                .color2{
                    background: white;
                    border: 1px solid red;
                    height: 18px;
                    width: 50px;
                    padding: 1px;
                    padding-top: -4px; 
                    line-height: 15px;
                    color: red;
                    // font-weight: 400;
                }
                .color3{
                    background: white;
                    border: 1px solid rgb(255, 174, 0);
                    height: 18px;
                    width: 50px;
                    padding: 1px;
                    padding-top: -4px; 
                    line-height: 15px;
                    color: rgb(255, 174, 0);
                    // font-weight: 400;
                }
                .color4{
                    background: white;
                    border: 1px solid green;
                    height: 18px;
                    width: 50px;
                    padding: 1px;
                    padding-top: -4px; 
                    line-height: 15px;
                    color: green;
                    // font-weight: 400;
                }
            }
        }
    }
    
}
</style>
<style lang="less">
#knowledge-detail{
    img{
        max-width: 100%;
    }
}
.knowledge-loading{
    width: 100%;
    height: 200px;
}
</style>
