<template>
  <div id="cachalot">
    
      <el-form class="searchForm" label-position="left" label-width="80px" :inline='true'>

        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="漏洞单号">
              <el-input class="searchInput"
                        v-model="queryParam.keywords.vul_id"
                        placeholder="请输入漏洞单号"
                        clearable
                        auto-complete="off">
              </el-input>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="漏洞名称">
              <el-input class="searchInput"
                        v-model="queryParam.keywords.vul_name"
                        placeholder="请输入漏洞名称"
                        clearable
                        auto-complete="off">
              </el-input>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="漏洞分类">
              <el-cascader id="el-cascader"
                        class="searchInput"
                        :options="vulType"
                        v-model="vulTypeArray"
                        change-on-select
                        clearable
                        placeholder="请选择漏洞分类"
                        @change="vulTypeValue"
                        expand-trigger="hover">
              </el-cascader>
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="漏洞等级">
              <el-select class="searchInput"
                        v-model="queryParam.keywords.vul_level_id"
                        placeholder="请选择漏洞等级"
                        clearable>
                <el-option v-for="item in vulLevel"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value">
                </el-option>
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="漏洞状态">
              <el-select class="searchInput"
                        v-model="queryParam.keywords.vul_status"
                        placeholder="请选择漏洞状态"
                        clearable
                        multiple>
                <el-option v-for="item in vulStatus"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value">
                </el-option>
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="漏洞来源">
              <el-multi-cascader class="searchInput"
                                placeholder="请选择漏洞来源"
                                :options="vulSource"
                                multiple
                                :change-on-select="true"
                                v-model="queryParam.keywords.vul_source"
                                :only-out-put-leaf-node="true"
                                :select-children="true"
                                clearable>
              </el-multi-cascader>
            </el-form-item>
          </el-col>
        </el-row>

        <el-collapse-transition>
          <div class="toggleBox" v-show="showToggleBox">
            <el-row :gutter="20">
              <el-col :span="8">
                <el-form-item label="部门名称">
                  <app-department class="searchInput" v-model="queryParam.keywords.dept_id"></app-department>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="R2漏洞">
                  <el-select class="searchInput"
                            v-model="queryParam.keywords.is_r2"
                            placeholder="请选择"
                            clearable>
                    <el-option v-for="item in isR2"
                      :key="item.value"
                      :label="item.label"
                      :value="item.value">
                    </el-option>
                  </el-select>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="未检出原因">
                  <el-select class="searchInput"
                            v-model="queryParam.keywords.is_what_reason"
                            placeholder="请选择"
                            clearable>
                    <el-option v-for="item in isWhatReason"
                      :key="item.value"
                      :label="item.label"
                      :value="item.value">
                    </el-option>
                  </el-select>
                </el-form-item>
              </el-col>
            </el-row>

            <el-row :gutter="20">
              <el-col :span="8">
                <el-form-item label="黑盒转化">
                  <el-select class="searchInput"
                            v-model="queryParam.keywords.is_transform_black"
                            placeholder="请选择"
                            clearable>
                    <el-option v-for="item in isTransformBlack"
                      :key="item.value"
                      :label="item.label"
                      :value="item.value">
                    </el-option>
                  </el-select>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="白盒转化">
                  <el-select class="searchInput"
                            v-model="queryParam.keywords.is_transform_white"
                            placeholder="请选择"
                            clearable>
                    <el-option v-for="item in isTransformWhite"
                      :key="item.value"
                      :label="item.label"
                      :value="item.value">
                    </el-option>
                  </el-select>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="移动端转化">
                  <el-select class="searchInput"
                            v-model="queryParam.keywords.is_transform_mobile"
                            placeholder="请选择"
                            clearable>
                    <el-option v-for="item in isTransformMobile"
                      :key="item.value"
                      :label="item.label"
                      :value="item.value">
                    </el-option>
                  </el-select>
                </el-form-item>
              </el-col>
            </el-row>

            <el-row :gutter="20">
              <el-col :span="8">
                <el-form-item label="设计转化">
                  <el-select class="searchInput"
                            v-model="queryParam.keywords.is_transform_design"
                            placeholder="请选择"
                            clearable>
                    <el-option v-for="item in isTransformDesign"
                      :key="item.value"
                      :label="item.label"
                      :value="item.value">
                    </el-option>
                  </el-select>
                </el-form-item>
              </el-col>
              <el-col :span="8">
                <el-form-item label="上报时间">
                  <el-date-picker class="searchInput"
                    v-model="vulPostTimeArray"
                    type="daterange"
                    range-separator="至"
                    start-placeholder="开始日期"
                    end-placeholder="结束日期"
                    value-format="yyyy-MM-dd"
                    @change="vulPostTime">
                  </el-date-picker>
                </el-form-item>
              </el-col>
            </el-row>
          </div>
      </el-collapse-transition>

        <el-row>
          <el-col :span='24'>
            <el-form-item align="center">
              <button type="button" class='cachalot-btn' @click="searchVul"><span>搜&nbsp;索</span></button>
            </el-form-item>
            <el-button class="toggleBtn" @click="toggleBox">
              <!-- <i v-if="!showToggleBox" class="el-icon-arrow-down el-icon--left"></i>
              <i v-if="showToggleBox" class="el-icon-arrow-up el-icon--left"></i> -->
              <i v-if="!showToggleBox" class="iconfont icon-arrow-down-double"></i>
              <i v-if="showToggleBox" class="iconfont icon-arrow-up-double"></i>
              <span>{{handleToggleContent()}}</span>
              </el-button>
            <el-button class="clearBtn" @click="clearSearchInput">清空条件</el-button>
          </el-col>
        </el-row>
      <!-- </div> -->
      <!-- </el-collapse-transition> -->
    </el-form>
    <!-- </div> -->
    

    <div class="cutLine"></div>

    <el-table
      :data="tableData"
      v-loading>
      <el-table-column
        prop="sdl_project_id"
        label="漏洞单号"
        sortable
        align="center"
        width="100">
        <template slot-scope="scope">
          <el-button class="button" type="text" size="mini" @click="goToUrl(scope.row.vul_id)">{{scope.row.vul_id}}</el-button>
        </template>
      </el-table-column>
      <el-table-column
        label="漏洞名称"
        sortable
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.vul_name}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="漏洞等级"
        sortable
        align="center"
        width="100">
        <template slot-scope="scope">
          <span>{{handleVulLevel(scope.row.vul_level_id)}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="漏洞状态"
        sortable
        align="center"
        width="120">
        <template slot-scope="scope">
          <span>{{handleVulStatus(scope.row.vul_status)}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="部门"
        sortable
        align="center"
        width="160">
        <template slot-scope="scope">
          <span>{{scope.row.dept_name}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="上报时间"
        sortable
        align="center"
        width="110">
        <template slot-scope="scope">
          <span>{{scope.row.vul_post_time.split(' ')[0]}}<br>{{scope.row.vul_post_time.split(' ')[1]}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="操作"
        sortable
        align="center"
        width="140">
        <template slot-scope="scope" prop="is_disable">
          <el-button class="button" type="text" size="mini" @click="openDialog('look',scope.row)">查看</el-button>
          <el-button class="button" type="text" size="mini" @click="openDialog('edit',scope.row)">编辑</el-button>
          <el-button class="button" type="text" size="mini" @click="openDialog('delete',scope.row)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <div align="right" style="margin-top: 10px;">
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="queryParam.page"
        :page-sizes="[10,20,30,50]"
        :page-size="queryParam.limit"
        layout="total, sizes, prev, pager, next, jumper"
        :total="num">
      </el-pagination>
    </div>

    <!-- 编辑查看漏洞 -->
    <el-dialog :title="action==3 ? '查看漏洞':'编辑漏洞'"
               :visible.sync="dialogFormVisible"
               width="1050px">
      <el-form :inline="true" label-width="85px" label-position="left">
        <div class="displayFlex">
          <el-form-item label="漏洞单号">
            <el-input class="inputWidth" v-model="vulDetail.vul_id" placeholder="" clearable :disabled="true"></el-input>
          </el-form-item>
          <el-form-item label="漏洞名称" style="margin-left: 30px;">
            <el-input class="inputWidth" v-model="vulDetail.vul_name" placeholder="" clearable :disabled="true"></el-input>
          </el-form-item>
          <el-form-item label="漏洞状态" style="margin-left: 30px;">
            <el-select class="inputWidth" v-model="vulDetail.vul_status" placeholder="" clearable :disabled="true">
              <el-option v-for="item in vulStatus"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
        </div>
        <div class="displayFlex">
          <el-form-item label="漏洞等级">
            <el-select class="inputWidth" v-model="vulDetail.vul_level_id" placeholder="" clearable :disabled="!editable">
              <el-option v-for="item in vulLevel"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="漏洞分类" style="margin-left: 30px;">
            <el-cascader class="inputWidth"
                       :options="vulType"
                       v-model="vulTypeArrayDetail"
                       change-on-select
                       placeholder=""
                       clearable
                       @change="vulTypeValueDetail"
                       expand-trigger="hover"
                       :disabled="!editable">
            </el-cascader>
          </el-form-item>
          <el-form-item label="漏洞来源" style="margin-left: 30px;">
            <el-cascader class="inputWidth"
                       :options="vulSource"
                       v-model="vulSourceArrayDetail"
                       change-on-select
                       placeholder=""
                       clearable
                       @change="vulSourceValueDetail"
                       expand-trigger="hover"
                       :disabled="!editable">
            </el-cascader>
          </el-form-item>
        </div>
        <div class="displayFlex">
          <el-form-item label="上报时间">
            <el-input class="inputWidth" v-model="vulDetail.vul_post_time" placeholder="" clearable :disabled="true"></el-input>
          </el-form-item>
          <el-form-item label="确认时间" style="margin-left: 30px;">
            <el-input class="inputWidth" v-model="vulDetail.vul_confirm_time" placeholder="" clearable :disabled="true"></el-input>
          </el-form-item>
          <el-form-item label="超期时间" style="margin-left: 30px;">
            <el-input class="inputWidth" v-model="vulDetail.vul_expire_time" placeholder="" clearable :disabled="true"></el-input>
          </el-form-item>
        </div>
        <div class="displayFlex">
          <el-form-item label="部门名称">
            <el-input class="inputWidth" v-if="!editable" v-model="vulDetail.dept_name" clearable :disabled="true"></el-input>
            <app-department class="inputWidth" v-if="editable" v-model="vulDetail.dept_name" :disabled="!editable"></app-department>
          </el-form-item>
          <el-form-item label="同步时间" style="margin-left: 30px;">
            <el-input class="inputWidth" v-model="vulDetail.sync_time" placeholder="" clearable :disabled="true"></el-input>
          </el-form-item>
          <el-form-item label="不同步字段" style="margin-left: 30px;">
            <app-non-sync class="inputWidth" v-model="vulDetail.non_sync_column" multiple clearable :disabled="!editable"></app-non-sync>
          </el-form-item>
        </div>
        <div class="displayFlex">
          <el-form-item label="漏洞修复人">
            <div class = "buttonGroup">
              <el-button class="button" v-for="(vulRepairPeople, key) in vulRepairPeopleList" :key="key" @click="goToPersonUrl(vulRepairPeople.email)">{{vulRepairPeople.name}}</el-button>
            </div>
          </el-form-item>
        </div>

        <div class="dialogCutLine"></div>

        <div class="displayFlex">
          <el-form-item label="R2漏洞">
            <el-select class="inputWidth" v-model="vulDetail.is_r2" placeholder="" clearable :disabled="!editable">
              <el-option v-for="item in isR2"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="未发现原因" style="margin-left: 30px;">
            <el-select class="inputWidth" v-model="vulDetail.is_what_reason" placeholder="" clearable :disabled="!editable">
              <el-option v-for="item in isWhatReason"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="重复漏洞" style="margin-left: 30px;">
            <el-select class="inputWidth" v-model="vulDetail.is_repetitive" placeholder="" clearable :disabled="!editable">
              <el-option v-for="item in isRepetitive"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
        </div>
        <div class="displayFlex">
          <el-form-item label="漏洞责任方">
            <el-select class="inputWidth" v-model="vulDetail.is_whose_responsibility" placeholder="" clearable :disabled="!editable">
              <el-option v-for="item in isWhoseResponsibility"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="黑盒转化" style="margin-left: 30px;">
            <el-select class="inputWidth" v-model="vulDetail.is_transform_black" placeholder="" clearable :disabled="!editable">
              <el-option v-for="item in isTransformBlack"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="白盒转化" style="margin-left: 30px;">
            <el-select class="inputWidth" v-model="vulDetail.is_transform_white" placeholder="" clearable :disabled="!editable">
              <el-option v-for="item in isTransformWhite"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
        </div>
        <div class="displayFlex">
          <el-form-item label=" 移动端转化">
            <el-select class="inputWidth" v-model="vulDetail.is_transform_mobile" placeholder="" clearable :disabled="!editable">
              <el-option v-for="item in isTransformMobile"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="设计转化" style="margin-left: 30px;">
            <el-select class="inputWidth" v-model="vulDetail.is_transform_design" placeholder="" clearable :disabled="!editable">
              <el-option v-for="item in isTransformDesign"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="漏洞计数" style="margin-left: 30px;">
            <el-input class="inputWidth" v-model="vulDetail.vul_count_amended" placeholder="" clearable :disabled="!editable"></el-input>
          </el-form-item>
        </div>
        <div class="displayFlex">
          <el-form-item label="git地址">
            <el-input class="inputWidth" v-model="vulDetail.vul_git_url" placeholder="" clearable :disabled="!editable"></el-input>
          </el-form-item>
          <el-form-item label="代码详情" style="margin-left: 30px;">
            <el-input class="inputWidth" v-model="vulDetail.vul_code_detail" placeholder="" clearable :disabled="!editable"></el-input>
          </el-form-item>
          <el-form-item label="漏洞域名" style="margin-left: 30px;">
            <el-input class="inputWidth" v-model="vulDetail.vul_domain" placeholder="" clearable :disabled="!editable"></el-input>
          </el-form-item>
        </div>

      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button class="dialogCancelBtn" @click="dialogFormVisible = false">取消</el-button>
        <el-button class="dialogConfirmBtn" type="warning" round @click="updateVul(vulDetail)">确定</el-button>
      </div>
    </el-dialog>

    <el-dialog title="提示"
               :visible.sync="warnDialogVisible"
               width="30%">
      <span>是否确认删除此漏洞？</span>
      <span slot="footer" class="dialog-footer">
        <el-button class="cancelBtn" @click="warnDialogVisible = false">取消</el-button>
        <el-button class="confirmBtn" type="primary" @click="deleteVul(vulDetail.vul_id)">确定</el-button>
      </span>
    </el-dialog>

  </div>


</template>

<script>
import ajax from '@/plugin/ajax'
import * as API from '@/commons/api/cachalot'
import * as CONSTANTS from '@/commons/cachalot'
import appDepartment from './components/department'
import appNonSync from './components/nonSyncColumn'
import elMultiCascader from 'multi-cascader-base-ele'

export default {
  data() {
    return {
      num: 0,
      showToggleBox: false,
      tableData: [],
      vulStatus: CONSTANTS.vulStatus,
      vulLevel: CONSTANTS.vulLevel,
      isR2: CONSTANTS.isR2,
      isRepetitive: CONSTANTS.isRepetitive,
      isWhatReason: CONSTANTS.isWhatReason,
      isWhoseResponsibility: CONSTANTS.isWhoseResponsibility,
      isTransformBlack: CONSTANTS.isTransformBlack,
      isTransformWhite: CONSTANTS.isTransformWhite,
      isTransformMobile: CONSTANTS.isTransformMobile,
      isTransformDesign: CONSTANTS.isTransformDesign,
      vulType: CONSTANTS.vulType,
      vulSource: CONSTANTS.vulSource,
      vulTypeArray: [],
      vulTypeArrayDetail: [],
      vulSourceArray: [],
      vulSourceArrayDetail: [],
      selectedVulSource: [],
      vulRepairPeopleList: [],
      vulPostTimeArray: [],
      dialogFormVisible: false,
      warnDialogVisible: false,
      editable: false,
      action: 0,
      vulDetail: {},
      nonSyncColumnList: [],
      queryParam: {
        page: 1,
        limit: 20,
        keywords: {
        vul_id: '',
        vul_name: '',
        vul_status: [],
        vul_level_id: '',
        vul_type1_id: '',
        vul_type2_id: '',
        vul_source: [],
        vul_source1_id: '',
        vul_source2_id: '',
        dept_id: '',
        is_r2: '',
        is_what_reason: '',
        is_transform_black: '',
        is_transform_white: '',
        is_transform_mobile: '',
        is_transform_design: '',
        vul_post_begin_time: '',
        vul_post_end_time: ''
        }
      },
      deleteParam: {
        vul_id: ''
      }
    }
  },
  components: {appDepartment, appNonSync, elMultiCascader},
  mounted() {
    this.fetchData()
  },
  methods: {
    fetchData() {

      // if (this.queryParam.keywords.is_r2 == null) {
      //   this.queryParam.keywords.is_r2 == ''
      // }
      let postJson = this.queryParam
      let a = document.getElementById('el-cascader');
      a.clearable = true;
      console.log(postJson)
      ajax.post(API.getVulList, postJson).then(response => {
        const vulData = response.data
        this.tableData = vulData.cachalot_vul_list
        this.num = vulData.count
      })
    },
    searchVul() {
      this.fetchData()
    },
    handleToggleContent() {
      let toggleContent
      if (this.showToggleBox) {
        toggleContent = '收起'
      } else {
        toggleContent = '更多条件'
      }
      return toggleContent
    },
    toggleBox() {
      this.showToggleBox = !this.showToggleBox;
    },
    handleSizeChange(val) {
      this.queryParam.limit = val
      this.fetchData()
    },
    handleCurrentChange(val) {
      this.queryParam.page = val
      this.fetchData()
    },
    vulTypeValue() {
      this.queryParam.keywords.vul_type1_id = this.vulTypeArray[0];
      this.queryParam.keywords.vul_type2_id = this.vulTypeArray[1];
    },
    vulTypeValueDetail() {
      this.vulDetail.vul_type1_id = this.vulTypeArrayDetail[0];
      this.vulDetail.vul_type2_id = this.vulTypeArrayDetail[1];
    },
    vulSourceValue() {
      this.queryParam.keywords.vul_source1_id = this.vulSourceArray[0];
      this.queryParam.keywords.vul_source2_id = this.vulSourceArray[1];
    },
    vulSourceValueDetail() {
      this.vulDetail.vul_source1_id = this.vulSourceArrayDetail[0];
      this.vulDetail.vul_source2_id = this.vulSourceArrayDetail[1];
    },
    vulPostTime() {
      if (this.vulPostTimeArray) {
        this.queryParam.keywords.vul_post_begin_time = this.vulPostTimeArray[0];
        this.queryParam.keywords.vul_post_end_time = this.vulPostTimeArray[1];
      } else {
        this.queryParam.keywords.vul_post_begin_time = '';
        this.queryParam.keywords.vul_post_end_time = '';
      }
    },
    handleVulLevel(vulLevelId) {
      let vulLevel
      if (vulLevelId == null) {
        vulLevel = ''
      } else {
        vulLevel = this.vulLevel[vulLevelId].label
      }
      return vulLevel
    },
    handleVulStatus(vulStatusId) {
      let vulStatus
      if (vulStatusId == null) {
        vulStatus = ''
      } else {
        vulStatus = this.vulStatus[vulStatusId].label
      }
      return vulStatus
    },
    openDialog(action = 'look', text) {
      if (action === 'edit') {
        let that = this
        this.action = 1
        this.editable = true
        this.vulDetail = text

        // 部门
        if (!this.vulDetail.dept_id) {
          this.vulDetail.dept_id = ''
        }

        // 漏洞类型
        if (this.vulDetail.vul_type1_id != '') {
          this.vulTypeArrayDetail.splice(0, 1, this.vulDetail.vul_type1_id)
          if (this.vulDetail.vul_type2_id != '') {
            this.vulTypeArrayDetail.splice(1, 1, this.vulDetail.vul_type2_id)
          } else {
            this.vulTypeArrayDetail.splice(1, 1, '')
          }
        } else {
          this.vulTypeArrayDetail.splice(0, 1, '')
        }

        // 漏洞来源
        if (this.vulDetail.vul_source1_id != '') {
          this.vulSourceArrayDetail.splice(0, 1, this.vulDetail.vul_source1_id)
          if (this.vulDetail.vul_source2_id != '') {
            this.vulSourceArrayDetail.splice(1, 1, this.vulDetail.vul_source2_id)
          } else {
            this.vulSourceArrayDetail.splice(1, 1, '')
          }
        } else {
          this.vulSourceArrayDetail.splice(0, 1, '')
        }

        // 非同步字段
        if (typeof (that.vulDetail.non_sync_column) != 'object' && that.vulDetail.non_sync_column != '') {
          this.vulDetail.non_sync_column = this.vulDetail.non_sync_column.split('|')
        }

        // 漏洞修复人
        if (this.vulDetail.vul_repair_people != '') {
          this.vulRepairPeopleList = JSON.parse(this.vulDetail.vul_repair_people);
          let i;
          for (i = 0; i < this.vulRepairPeopleList.length; i++) {
            let tmp = this.vulRepairPeopleList[i].email.split('@')
            this.vulRepairPeopleList[i].email = tmp[0];
          }
        }

        if (that.vulDetail.non_sync_column.length == ['']) that.vulDetail.non_sync_column = []
        this.dialogFormVisible = true

        this.fetchData()
      } else if (action === 'delete') {
        this.warnDialogVisible = true
        this.vulDetail = text
      } else {
        let that = this
        this.action = 3
        this.vulDetail = text

        // 漏洞类型
        if (this.vulDetail.vul_type1_id != '') {
          this.vulTypeArrayDetail.splice(0, 1, this.vulDetail.vul_type1_id)
          if (this.vulDetail.vul_type2_id != '') {
            this.vulTypeArrayDetail.splice(1, 1, this.vulDetail.vul_type2_id)
          } else {
            this.vulTypeArrayDetail.splice(1, 1, '')
          }
        } else {
          this.vulTypeArrayDetail.splice(0, 1, '')
        }

        // 漏洞来源
        if (this.vulDetail.vul_source1_id != '') {
          this.vulSourceArrayDetail.splice(0, 1, this.vulDetail.vul_source1_id)
          if (this.vulDetail.vul_source2_id != '') {
            this.vulSourceArrayDetail.splice(1, 1, this.vulDetail.vul_source2_id)
          } else {
            this.vulSourceArrayDetail.splice(1, 1, '')
          }
        } else {
          this.vulSourceArrayDetail.splice(0, 1, '')
        }

        // 非同步字段
        if (typeof (that.vulDetail.non_sync_column) != 'object' && that.vulDetail.non_sync_column != '') {
          this.vulDetail.non_sync_column = this.vulDetail.non_sync_column.split('|')
        }

        // 漏洞修复人
        if (this.vulDetail.vul_repair_people != '') {
          this.vulRepairPeopleList = JSON.parse(this.vulDetail.vul_repair_people);
          let i;
          for (i = 0; i < this.vulRepairPeopleList.length; i++) {
            let tmp = this.vulRepairPeopleList[i].email.split('@')
            this.vulRepairPeopleList[i].email = tmp[0];
          }
        }

        this.editable = false
        this.dialogFormVisible = true

        // this.fetchData()
      }
    },
    updateVul(param) {
      if (this.action == 1) {
        param.non_sync_column = param.non_sync_column.join('|')
        if (typeof (this.vulDetail.dept_name) == 'number') {
          param.dept_id = this.vulDetail.dept_name
        }
        let postJson = param
        ajax.post(API.updateVul, postJson).then(response => {
        })
        this.fetchData()
      }
      this.dialogFormVisible = false
    },
    deleteVul(param) {
      this.deleteParam.vul_id = param
      let postJson = this.deleteParam
      ajax.post(API.deleteVul, postJson).then(response => {
      })
      this.fetchData()
      this.warnDialogVisible = false
    },
    goToUrl(id) {
      let myUrl = 'http://anquan.didichuxing.com/project/portals/pages/hole-detail.html?id=' + id
      window.open(myUrl)
    },
    goToPersonUrl(username) {
      let myUrl = 'http://i.xiaojukeji.com/space/personal/' + username
      window.open(myUrl)
    },
    clearSearchInput() {
      this.queryParam.keywords = {
        vul_id: '',
        vul_name: '',
        vul_status: [],
        vul_level_id: '',
        vul_type1_id: '',
        vul_type2_id: '',
        vul_source: [],
        vul_source1_id: '',
        vul_source2_id: '',
        dept_id: '',
        is_r2: '',
        is_what_reason: '',
        is_transform_black: '',
        is_transform_white: '',
        is_transform_mobile: '',
        is_transform_design: '',
        vul_post_begin_time: '',
        vul_post_end_time: ''
      }

        // 清空漏洞类型和上报时间查询条件
        this.vulTypeArray.splice(0, 1, '')
        this.vulTypeArray.splice(1, 1, '')
        this.vulPostTimeArray.splice(0, 1, '')
        this.vulPostTimeArray.splice(1, 1, '')
    }
  }
}
</script>

<style lang='less'>
#cachalot {
    background: white;
    -webkit-font-smoothing: antialiased;
    .el-table {
      .el-button {
        font-size: 12.5px;
      }
    }
    .toggleBtn {
      font-size: 13px;
      background-color: white;
      padding: 15px 0;
      color: #FC9153;
      margin-right: 5px;
      margin-left: 20px;
      border: none;
      // width: 60px;
      -webkit-font-smoothing: antialiased;
      i {
        margin: 0;
        font-size: 14px;
      }
      span {
        margin: 0;
      }
    }
    .clearBtn {
      font-size: 13px;
      background-color: white;
      padding: 15px 0;
      color: #FC9153;
      margin-right: 20px;
      border: none;
      -webkit-font-smoothing: antialiased;
      i {
        margin: 0;
      }
      span {
        margin: 0;
      }
    }
    .el-table .cell{
      word-break: break-word;
    }
    .cachalot-btn {
      background: #FC9153;
      border-radius: 4px;
      width: 95px;
      height: 32px;
      border: none;
      color: white;
      margin-top: 5px;
      margin-left: 80px;
      font-size: 13px;
      -webkit-font-smoothing: antialiased;
      cursor: pointer;
      span {
        font-family: Avenir, Helvetica, Arial, sans-serif;
      }
    }
    .displayFlex {
      display: flex;
    }
    .searchInput {
      width: 230px;
    }
    .cutLine {
      // border: 1px solid
      margin-top: 5px;
      margin-bottom: 17px;
      width: 100%;
      border-top: 1px solid rgba(0, 0, 0, 0.10);
      // background: rgba(0, 0, 0, 0.10);
      // border-radius: 4px;
    }
    .dialogCutLine {
      // border: 1px solid
      margin-top: 12px;
      margin-bottom: 22px;
      // margin-left: auto;
      // margin-right: auto;
      width: 100%;
      border-top: 1px solid rgba(0, 0, 0, 0.01);
      background: rgba(0, 0, 0, 0.10);
      border-radius: 4px;
    }
    .dialogCancelBtn {
      font-size: 13px;
      width: 90px;
      height: 32px;
      padding: 5px;
      // font-weight: 100;
    }
    .dialogConfirmBtn {
      font-size: 13px;
      background: #FC9153;
      border-radius: 4px;
      // height:36px;
      width: 90px;
      height: 32px;
      padding: 5px;
      border: none;
      // font-weight: 100;
      // margin-right: 13px;
    }
    .el-cascader {
      span.el-select__tags-text {
        color: #909399;
      }
    }
    .el-cascader-menu__item--extensible:after {
        font-family: 'element-icons';
        content: "\e604" !important;
        font-size: 14px;
        color: #bfcbd9;
        position: absolute;
        right: 15px;
    }
    .el-cascader-menu__item.is-active {
        color: #fc9153 !important;
    }
    .multi-el-cascader-menu__item.is-active /deep/ {
        color: #fc9153 !important;
    }
    .el-dialog {
      position: absolute;
      top: 50%;
      left: 50%;
      margin: 0 !important;
      transform: translate(-50%, -50%);
      .el-form-item {
        margin-bottom: 8px;
      }
      .inputWidth {
        width: 230px;
      }
      .el-dialog__body {
        padding: 25px 20px 20px 20px;
        .buttonGroup {
          .button {
            font-size: 13px;
          }
        }
        .button {
          border: none;
          color:#FC9153;
          padding: 0px;
          background-color: white;
          -webkit-font-smoothing: antialiased;
        }
        .button:hover {
          background-color: white;
        }
      }
      .dialog-footer-center {
        text-align: center;
      }
      .el-cascader.is-disabled {
        span {
          color: #c0c4cc;
        }
      }
    }
    .select-value {
      display: inline-block;
      vertical-align: top;
      margin-bottom: 10px;
      width: 200px;
      min-height: 100px;
      border: 1px solid #eee;
      border-radius: 6px;
      padding: 10px;
      box-sizing: border-box;

      >span {
          display: block;
      }
    }
    .el-cascader {
      .el-input__inner {
        // height: 32px !important;
        // height: auto;
      }
    }
    .el-input__inner {
      // line-height: 32px !important;
    }
    .cancelBtn {
      width: 80px;
      height: 32px;
      padding: 7px 15px;
      font-size: 13px;
    }
    .confirmBtn {
      font-size: 13px;
      height: 32px;
      width: 80px;
      padding: 7px 15px;
      border: none;
    }
}
</style>

