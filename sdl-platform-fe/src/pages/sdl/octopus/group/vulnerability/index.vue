<template>
    <div id="octopus-vulnerability">
        <el-form class="searchForm" label-position="left" label-width="80px" :inline='true'>
      <div class="displayFlex">
        <el-form-item label="漏洞类型:">
              <el-cascader id="el-cascader"
                        class="searchInput"
                        :options="vulType"
                        v-model="vulTypeArray"
                        change-on-select
                        clearable
                        placeholder="请选择漏洞类型"
                        @change="vulTypeValue"
                        expand-trigger="hover">
              </el-cascader>
        </el-form-item>
        <el-form-item label="状态:" style="margin-left:50px;">
          <el-select class="searchInput"
                     v-model="queryParam.keywords.status"
                     filterable
                     clearable
                     placeholder="请选择状态">
            <el-option
              v-for="item in vulStatus"
              :key="item.value"
              :label="item.label"
              :value="item.value">
            </el-option>
          </el-select>
        </el-form-item>
        
      </div>

      <el-row>
        <el-col :span='24'>
          <el-form-item align="center">
            <button type="button" class='octopus-button' @click="fetchData"><span>搜&nbsp;索</span></button>
          </el-form-item>
        </el-col>
      </el-row>
    </el-form>

     <div class="cutLine"></div>

      <el-table
      :data="vulList"
      v-loading>
      <el-table-column type="expand">
        <template slot-scope="props">
          <el-form label-position="left" class="table-expand" label-width="90px">
            <el-form-item label="原始请求:">
              <span><pre class="preHandle">{{ props.row.raw_request }}</pre></span>
            </el-form-item>
            <el-form-item label="请求方法:">
              <span>{{ props.row.method }}</span>
            </el-form-item>
            <el-form-item label="参数:">
              <span>{{ props.row.param }}</span>
            </el-form-item>
            <el-form-item label="URL:">
              <span>{{ props.row.url }}</span>
            </el-form-item>
            <el-form-item label="插件标识:">
              <span>{{ props.row.vul_type }}</span>
            </el-form-item>
            <el-form-item label="备注:">
              <span>{{ props.row.remark }}</span>
            </el-form-item>
          </el-form>
        </template>
      </el-table-column>
      <el-table-column
        label="ID"
        width="70"
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.octopus_group_vul_id}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="项目名称"
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.octopus_group_project ? scope.row.octopus_group_project.group_project_name: ''}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="任务名称"
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.octopus_group_task.task_name}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="漏洞类型"
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.vul_knowledge_info.vul_knowledge_name}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="修复人"
        align="center">
        <template slot-scope="scope">
          <a :href="bounceDChat(scope.row.octopus_group_task.username)">
            <i class="engineerLogo"><img src="@/assets/D-Chat_logo.svg" alt="" style="width:14px;height:14px;"></i>
            <span class='engineerName'>{{scope.row.octopus_group_task.username_zh}}</span>
          </a>
        </template>
      </el-table-column>
      
      <el-table-column
        label="创建时间"
        width="100"
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.create_time.split(' ')[0]}}<br>{{scope.row.create_time.split(' ')[1]}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="状态"
        width="100"
        align="center">
        <template slot-scope="scope">
          <span>{{judgeStatus(scope.row.status)}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="安全工单"
        width="100"
        align="center">
        <template slot-scope="scope">
          <a v-if="scope.row.anquan_vul_id!==0" :href="bounceVulId(scope.row.anquan_vul_id)" target='_blank'>
            <span class='engineerName'>{{scope.row.anquan_vul_id}}</span>
          </a>
          <span v-else>{{'--'}}</span>
        </template>
      </el-table-column>
      <app-permission>
        <el-table-column
        label="操作"
        width="80"
        align="center">
        <template slot-scope="scope">
          <span class="opera" @click="openDialog(scope.row)">处理</span>
        </template>
      </el-table-column>
      </app-permission>
    </el-table>

    <div align="right" style="margin-top: 10px;">
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="queryParam.page"
        :page-sizes="[10,20,30, 50]"
        :page-size="queryParam.limit"
        layout="total, sizes, prev, pager, next, jumper"
        :total="num">
      </el-pagination>
    </div>
    <handle-dialog :dialogVisible='dialogVisible' @handleDia='getVisible' :octopusId='octopusId'></handle-dialog>
    </div>
</template>
<script>
import {connect} from '@/lib'
import * as CONSTANTS from '@/commons/octopus'
import handleDialog from './handleDialog'

  export default connect(() => {
    return {
    }
  }, {
      listVulnerability: 'octopus_group/listVulnerability'
  })({
    data() {
        return {
            vulList: [],
            num: 0,
            vulTypeArray: [],
            vulStatus: CONSTANTS.vulListStatus,
            vulType: CONSTANTS.vulListType,
            queryParam: {
                page: 1,
                limit: 10,
                keywords: {
                    vul_type2_id: null,
                    status: null
                }
            },
            dialogVisible: false,
            octopusId: null
        }
    },
    components: {handleDialog},
    created() {
        this.fetchData()
    },
    methods: {
        fetchData() {
            let queryParam = this.queryParam
            this.listVulnerability(queryParam).then(res => {
                this.vulList = []
                this.vulList = res.data.octopus_group_vulnerability_list
                this.num = res.data.count
            })
        },
        openDialog(scopeRow) {
            this.octopusId = scopeRow.octopus_group_vul_id
            this.dialogVisible = true
        },
        getVisible(val) {
            this.dialogVisible = val
        },
        vulTypeValue() {
            this.queryParam.keywords.vul_type2_id = this.vulTypeArray[1];
        },
        judgeStatus(type) {
            for (let i = 0; i < this.vulStatus.length; i++) {
                if (this.vulStatus[i].value === type) {
                    return this.vulStatus[i].label
                }
            }
        },
        handleSizeChange(val) {
            this.queryParam.limit = val
            this.fetchData()
        },
        handleCurrentChange(val) {
            this.queryParam.page = val
            this.fetchData()
        },
        bounceDChat(sdlDngineer) {

          // let url = 'dingtalk://dingtalkclient/action/sendmsg?dingtalk_id='
          let url = 'dchat://im/start_conversation?name='
          url += sdlDngineer
          return url
        },
        bounceVulId(id) {
          let url = 'http://anquan.didichuxing.com/project/portals/pages/hole-detail.html?id='
          url += id
          return url
        }
    }
})
</script>
<style lang="less">
#octopus-vulnerability {
    .displayFlex {
        display: flex;
    }
    .searchForm {
        .searchInput {
            width: 230px;
        }
    }
    .table-expand {
      padding: 10px 20px;
      .preHandle{
          padding: 8px 10px;
          height: 300px;
          overflow: scroll;
          background: #F3F4F5;
          line-height: 20px;
      }
    }
     .engineerName {
        line-height: 20px;
        color: #FC9153;
      }

      .engineerLogo {
        position: relative;
        top: 2px;
      }
    .octopus-btn{
        border: 1px solid #FC9153;
        border-radius: 4px;
        width: 95px;
        height: 32px;
        color: #FC9153;
        margin-left: 25px;
        background: white;
        cursor: pointer;
        margin-top: 5px;
        font-size: 13px;
        -webkit-font-smoothing: antialiased;
        // font-weight: 100;
        // line-height: 32px;
        span{
        font-family: Avenir,Helvetica,Arial,sans-serif;
        // font-weight: 100;
        }
    }
    .octopus-btn:hover{
        background-color: #fff3e8;
    }
    .octopus-button{
        background: #FC9153;
        border-radius: 4px;
        width: 95px;
        height: 32px;
        border: none;
        color: white;
        margin-top: 5px;
        margin-left: 80px;
        font-size: 13px;
        -webkit-font-smoothing: antialiased;
        cursor: pointer;
        span {
        font-family: Avenir, Helvetica, Arial, sans-serif;
        }
    }
    .opera {
        color: #FC9153;
        cursor: pointer;
        // display: inline-block;
        // margin-left: 5px;
    } 
    .cutLine {
        // border: 1px solid
        margin-top: 5px;
        margin-bottom: 17px;
        width: 100%;
        border-top: 1px solid rgba(0, 0, 0, 0.10);
        // background: rgba(0, 0, 0, 0.10);
        // border-rad
    }
}
</style>

