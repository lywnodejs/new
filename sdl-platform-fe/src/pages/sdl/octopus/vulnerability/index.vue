<template>
  <div class="el-main">
    <el-form class="searchForm" label-position="left" label-width="80px" :inline='true'>
      <div class="displayFlex">
        <el-form-item label="漏洞编号:">
          <el-input class="searchInput"
                    v-model="queryParam.keywords.oct_vul_main_id"
                    clearable
                    placeholder="请输入漏洞编号"
                    auto-complete="off">
          </el-input>
        </el-form-item>
        <el-form-item label="任务编号:" style="margin-left:30px;">
          <el-select class="searchInput"
                     v-model="queryParam.keywords.oct_task_main_id"
                     filterable
                     clearable
                     placeholder="请选择漏洞类型">
            <el-option
              v-for="item in preSearchList"
              :key="item.value"
              :label="item.label"
              :value="item.value">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="漏洞URL:" style="margin-left:30px;">
          <el-input class="searchInput"
                    v-model="queryParam.keywords.url"
                    clearable
                    placeholder="请输入漏洞URL"
                    auto-complete="off">
          </el-input>
        </el-form-item>
      </div>
      <div class="displayFlex">
        <el-form-item label="问题参数:">
          <el-input class="searchInput"
                    v-model="queryParam.keywords.param"
                    clearable
                    placeholder="请输入请求问题参数"
                    auto-complete="off">
          </el-input>
        </el-form-item>
        <el-form-item label="漏洞类型:" style="margin-left:30px;">
          <el-select class="searchInput"
                     v-model="queryParam.keywords.vul_type"
                     filterable
                     clearable
                     placeholder="请选择漏洞类型">
            <el-option
              v-for="item in vulType"
              :key="item.value"
              :label="item.label"
              :value="item.value">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="请求方式:" style="margin-left:30px;">
          <el-select class="searchInput"
                     v-model="queryParam.keywords.method"
                     filterable
                     clearable
                     placeholder="请选择请求方式">
            <el-option
              v-for="item in requestMethod"
              :key="item.value"
              :label="item.label"
              :value="item.value">
            </el-option>
          </el-select>
        </el-form-item>
      </div>
      <!-- <div class="displayFlex">
        <el-form-item label="漏洞状态"  style="margin-left: 35px;">
          <el-select class="searchInput"
                     v-model="queryParam.keywords.status"
                     filterable
                     clearable
                     placeholder="请选择漏洞状态">
            <el-option
              v-for="item in vulStatus"
              :key="item.value"
              :label="item.label"
              :value="item.value">
            </el-option>
          </el-select>
        </el-form-item> 
      </div> -->
      <app-permission>
        <div class="displayFlex">
          <el-form-item label="任务创建人:">
            <el-input class="searchInput"
                      v-model="queryParam.keywords.username"
                      clearable
                      placeholder="请输入任务创建人"
                      auto-complete="off">
            </el-input>
          </el-form-item>
        </div>
      </app-permission>

      <el-row>
        <el-col :span='24'>
          <el-form-item align="center">
            <button type="button" class='octopus-btn' @click="searchVulnerability"><span>搜&nbsp;索</span></button>
          </el-form-item>
        </el-col>
      </el-row>
    </el-form>

    <div class="cutLine"></div>

    <el-table
      :data="vulList"
      v-loading>
      <el-table-column
        prop="oct_vul_main_id"
        label="ID"
        sortable
        align="center"
        width="80">
      </el-table-column>
      <el-table-column
        label="任务编号"
        align="center"
        width="100">
        <template slot-scope="scope">
          <router-link :to="{ path : '/sdl/octopus/task',query: {taskId: scope.row.oct_task_main_id} }">
            <span>{{scope.row.oct_task_main_id}}</span>
          </router-link>
        </template>
      </el-table-column>
      <el-table-column
        label="漏洞类型"
        width="130"
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.vul_type}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="URL"
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.url}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="级别"
        width="80"
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.level}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="创建时间"
        width="100"
        align="center">
        <template slot-scope="scope">
          <span>{{scope.row.create_time.split(' ')[0]}}<br>{{scope.row.create_time.split(' ')[1]}}</span>
        </template>
      </el-table-column>
      <el-table-column
        label="操作"
        width="120px"
        align="center">
        <template slot-scope="scope">
          <span class="opera" @click="deleteVulnerabilityConfirm(scope.row.octopus_vul_id, '删除')">删除</span>
          <span class="opera" @click="openVulDetailTabs(scope.row)">详情</span>
        </template>
      </el-table-column>
    </el-table>

    <div align="right" style="margin-top: 10px;">
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="queryParam.page"
        :page-sizes="[10,20,30, 50]"
        :page-size="queryParam.limit"
        layout="total, sizes, prev, pager, next, jumper"
        :total="num">
      </el-pagination>
    </div>

    <el-dialog
      title="漏洞详情"
      :visible.sync="dialogFormVisible"
      width="650px">

      <el-tabs style="width: 100%">
        <el-tab-pane label="基本信息">
          <el-table
            :data="vulBasicInfo"
            :show-header='false'
            v-loading
            border>
            <el-table-column
              prop="label_1"
              align="left"
              min-width="18%">
            </el-table-column>
            <el-table-column
              align="left"
              min-width="32%">
              <template slot-scope="scope">
                <span>{{scope.row.value_1}}</span>
              </template>
            </el-table-column>
            <el-table-column
              prop="label_2"
              align="left"
              min-width="18%">
            </el-table-column>
            <el-table-column
              align="left"
              min-width="32%">
              <template slot-scope="scope">
                <span>{{scope.row.value_2}}</span>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>

        <el-tab-pane label="解决方案">
          <el-table
            :data="vulSolution"
            :show-header='false'
            v-loading
            border>
            <el-table-column
              prop="label"
              align="left"
              min-width="15%">
            </el-table-column>
            <el-table-column
              align="left"
              min-width="85%">
              <template slot-scope="scope">
                <span>{{scope.row.value}}</span>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>
        <el-tab-pane label="HTTP记录">
          <el-table
            :data="vulHttpRecord"
            :show-header='false'
            v-loading
            border>
            <el-table-column
              prop="label"
              align="left"
              min-width="15%">
            </el-table-column>
            <el-table-column
              align="left"
              min-width="85%">
              <template slot-scope="scope">
                <span><pre>{{scope.row.value}}</pre></span>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>
        <app-permission>
          <button class="vulCheck-btn" @click="vulCheck(vulId)">漏洞验证</button>
        </app-permission>
        <button v-if="repairRes.show_push == 'yes'" class="action-btn" @click="openVulPushDialog(vulId)">
          {{repairRes.menu_name}}
        </button>
        <button v-if="repairRes.show_redirect == 'yes'" class="action-btn" @click="vulRedirect(vulId)">
          {{repairRes.menu_name}}
        </button>
      </el-tabs>

    </el-dialog>
    <el-dialog
      title="推送漏洞"
      :visible.sync="pushFormVisible"
      width="460px">
      <el-form :model="pushParam" label-width="100px" label-position="left">
        <el-form-item class="createProjectDialog-input" prop="expireTime" label="过期时间">
          <el-date-picker
            v-model="pushParam.expireTime"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm:ss"
            placeholder="选择过期日期时间">
          </el-date-picker>
        </el-form-item>
        <el-form-item style="margin-top:10px" class="createProjectDialog-input" prop="repairPeople" label="修复人">
          <el-input
            v-model="pushParam.repairPeople"
            placeholder="请输入修复人，以逗号相隔"
            clearable
            auto-complete="off">
          </el-input>
        </el-form-item>
        <el-form-item style="margin-top:10px" class="createProjectDialog-input" prop="followers" label="关注人">
          <el-input
            v-model="pushParam.followers"
            placeholder="请输入关注人，以逗号相隔"
            clearable
            auto-complete="off">
          </el-input>
        </el-form-item>
        <el-form-item class="createProjectDialog-input" label="直接确认" prop="confirm_directly">
          <el-radio class="label" v-model="pushParam.confirm_directly" label=yes>是</el-radio>
          <el-radio class="label" v-model="pushParam.confirm_directly" label=no>否</el-radio>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button class="task-btn" @click="pushVul">保存</el-button>
        <el-button class="task-button" @click="pushFormVisible = false">取消</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
  import {connect} from '@/lib'
  import * as CONSTANTS from '@/commons/octopus'

  export default connect(() => {
    return {
      user: 'user/user',
      vulList: 'octopus_vulnerability/vulList',
      num: 'octopus_vulnerability/vulListLength'
    }
  }, {
    getVulList: 'octopus_vulnerability/getVulList',
    getVulDetail: 'octopus_vulnerability/getVulDetail',
    deleteVul: 'octopus_vulnerability/deleteVul',
    vulMisinformation: 'octopus_vulnerability/vulMisinformation',
    preSearch: 'octopus_vulnerability/preSearch',
    check: 'octopus_vulnerability/check',
    repair: 'octopus_vulnerability/repair',
    push: 'octopus_vulnerability/push',
    signAgreementUserAuth: 'octopus_userauth/signAgreementUserAuth',
    getUserAuth: 'octopus_userauth/getUserAuth'
  })({
    name: 'octopus-vulnerability-list',
    data() {
      return {
        requestMethod: CONSTANTS.requestMethod,
        vulType: CONSTANTS.vulType,
        vulStatus: CONSTANTS.vulStatus,
        vulLevel: CONSTANTS.vulLevel,
        dialogFormVisible: false,
        pushFormVisible: false,
        vulId: 0,
        vulBasicInfo: [],
        vulHttpRecord: [],
        vulSolution: [],
        preSearchList: [],
        repairRes: {
          anquan_plat_url: '',
          menu_name: '推送到安全平台',
          show_push: 'yes',
          show_redirect: 'no'
        },
        queryParam: {
          page: 1,
          limit: 10,
          keywords: {
            oct_vul_main_id: '',
            vul_type: '',
            method: '',
            oct_task_main_id: '',
            url: '',
            param: '',
            username: '',
            source_type: ''
          }
        },
        pushParam: {
          oct_vul_main_id: 0,
          expireTime: '',
          followers: '',
          repairPeople: '',
          confirm_directly: 'no'
        }
      }
    },
    created() {
      this.getUserInfo()
      this.preSearch().then(res => {
        this.preSearchList = res

        if (this.$route.query['oct_task_main_id']) {
          this.queryParam.keywords.oct_task_main_id = this.$route.query['oct_task_main_id']
        } else {
          this.queryParam.keywords.oct_task_main_id = this.preSearchList[0].value
        }
        this.fetchData()
      })
    },

    methods: {
      fetchData() {
        let queryParam = {queryParam: this.queryParam}
        this.getVulList(queryParam).then(res => {
        })
      },
      searchVulnerability() {
        this.fetchData()
      },

      // 重要操作提示框
      deleteVulnerabilityConfirm(vulId) {
        this.$confirm('此操作将删除漏洞, 是否继续?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.deleteVulnerability(vulId)
          this.fetchData()
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消删除漏洞'
          });
        });
      },
      deleteVulnerability(vulId) {
        this.deleteVul(vulId)
      },
      openVulDetailTabs(data) {
        this.vulRepair(data)
        this.vulBasicInfo = [
          {label_1: '漏洞ID', value_1: data.oct_vul_main_id, label_2: '所属任务ID', value_2: data.oct_task_main_id},
          {label_1: '漏洞URL', value_1: data.url, label_2: '请求方式', value_2: data.method},
          {label_1: '请求参数', value_1: data.postdata, label_2: '问题参数', value_2: data.param},
          {label_1: '漏洞类型', value_1: data.vul_type, label_2: '漏洞级别', value_2: data.level},
          {label_1: '漏洞状态', value_1: data.status, label_2: '创建时间', value_2: data.create_time}
        ]
        let num = data.raw_request.indexOf('>')
        this.vulHttpRecord = [
          {label: '验证信息', value: data.info},
          {label: '漏洞请求', value: data.raw_request.substring(0, num)},
          {label: '漏洞验证', value: data.raw_request.substring(num, data.raw_request.length)}
        ]
        this.vulSolution = [
          {label: '漏洞详情', value: data.desc},
          {label: '漏洞危害', value: data.harm},
          {label: '解决方案', value: data.advice}
        ]
        this.dialogFormVisible = true
        this.vulId = data.oct_vul_main_id
      },
      vulCheck(id) {
        this.check({octopus_vul_id: id}).then(response => {
          const errno = response.errno
          const errmsg = response.errmsg
          if (errno === 0) {
            this.$notify({
              title: '漏洞检测成功',
              message: errmsg,
              type: 'success'
            })
          } else {
            this.$notify({
              title: '漏洞检测成功',
              message: errmsg,
              type: 'error'
            })
          }
        })
      },
      vulRepair(obj) {
        let param = {oct_vul_main_id: obj.oct_vul_main_id}
        this.repair(param).then(res => {
          this.repairRes = res.data
        })
      },
      openVulPushDialog(val) {
        this.pushParam.oct_vul_main_id = val
        this.pushFormVisible = true
      },
      pushVul() {
        if (typeof this.pushParam.repairPeople == 'string') {
          this.pushParam.repairPeople = this.pushParam.repairPeople.split(',')
        }
        if (typeof this.pushParam.followers == 'string') {
          this.pushParam.followers = this.pushParam.followers.split(',')
        }
        this.push(this.pushParam).then(response => {
          const errno = response.errno
          const errmsg = response.errmsg
          if (errno === 0) {
            this.$notify({
              title: '漏洞推送成功',
              message: errmsg,
              type: 'success'
            })
          } else {
            this.$notify({
              title: '漏洞推送成功',
              message: errmsg,
              type: 'error'
            })
          }
        })
        this.pushFormVisible = false
      },
      vulRedirect() {
        let anquanPlatUrl = this.repairRes.anquan_plat_url
        this.$confirm(`请点击确定按钮跳转至 ${anquanPlatUrl} 查看漏洞修复流程！`, '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          if (anquanPlatUrl) {
            window.open(anquanPlatUrl)
          }
          this.fetchData()
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消跳转'
          });
        })
      },

      // 分页
      handleSizeChange(val) {
        this.queryParam.limit = val
        this.fetchData()
      },
      handleCurrentChange(val) {
        this.queryParam.page = val
        this.fetchData()
      },
      getUserInfo() {
        let param = {username: this.user.username}
        this.getUserAuth(param).then(res => {
          if (res.data.user_agreement_status !== 'yes') {
            this.open()
          }
        })
      },
      confirm() {
        let param = {user_agreement_status: 'yes'}
        this.signAgreementUserAuth(param).then(res => {
          if (res.errno == 0) {

          }
          this.$notify({
            title: '成功',
            message: '已开通权限',
            type: 'success'
          })
        })
      },
      open() {
        let text = `<div>
          1.创建任务时扫描目标只能是自己负责的机器、WEB服务等，不可扫描他人的任何形式的IT资源。<br>
          2.因黑盒扫描任务对扫目标造成的任何不利影响、违规事件等责任均由扫描任务创建者自行承担。<br><br>
          如果不同意上述条款，将无法使用黑盒服务。
        </div>`
        this.$alert(text, '使用黑盒扫描服务前请遵守以下约定:  ', {
          confirmButtonText: '同意',
          dangerouslyUseHTMLString: true,
          showClose: false,
          callback: action => {
            this.confirm()
          }
        });
      }
    }
  })
</script>

<style lang='less' scoped>
  .octopus-btn {
    background: #FC9153;
    border-radius: 4px;
    width: 95px;
    height: 32px;
    border: none;
    color: white;
    cursor: pointer;
    // font-weight: 100;
    margin-top: 5px;
    margin-left: 80px;
    font-size: 13px;
    -webkit-font-smoothing: antialiased;
    span {
      font-family: Avenir, Helvetica, Arial, sans-serif;
      // font-weight: 100;
    }
  }

  .el-table th {
    background: #DDDDDD !important;
    font-size: large;
  }

  .el-input {
    width: 320px;
  }

  .el-select {
    width: 320px;
  }

  .el-main {
    width: 100%;
    box-sizing: border-box;
    background: white;
    // margin-bottom: 20px;
    // padding: 20px;
    // margin-left: -0px;
    // margin-top: -15px;
    // padding-right: -20px;
    .displayFlex {
      display: flex;
    }
    .searchForm {
      .searchInput {
        width: 230px;
      }
    }
  }

  .el-input__inner {
    width: 320px;
  }

  .el-tabs__item {
    width: 100%;
  }

  .cutLine {
    // border: 1px solid
    margin-top: 5px;
    margin-bottom: 17px;
    width: 100%;
    border-top: 1px solid rgba(0, 0, 0, 0.10);
    // background: rgba(0, 0, 0, 0.10);
    // border-rad
  }

  .vulCheck-btn {
    background: #FC9153;
    border-radius: 4px;
    width: 95px;
    height: 32px;
    font-size: 13px;
    border: none;
    color: white;
    cursor: pointer;
    // font-weight: 100;
    float: right;
    -webkit-font-smoothing: antialiased;
    margin-top: 20px;
  }

  .action-btn {
    background: #FC9153;
    border-radius: 4px;
    width: 120px;
    height: 32px;
    border: none;
    font-size: 13px;
    color: white;
    cursor: pointer;
    // font-weight: 100;
    float: right;
    -webkit-font-smoothing: antialiased;
    margin-top: 20px;
    margin-right: 10px;
  }

  .task-button {
    // font-weight: 300;
    height: 32px;
    float: right;
    -webkit-font-smoothing: antialiased;
    margin-left: 20px;
    font-size: 13px;
    // margin-top: -15px;
    width: 90px;
  }

  .task-btn {
    -webkit-font-smoothing: antialiased;
    // font-weight: 100;
    // float: right;
    height: 32px;
    background: #FC9153;
    border: #FC9153;
    color: white;
    font-size: 13px;
    margin-left: 20px;
    // margin-top: -15px;
    width: 90px;
  }

  .opera {
    color: #FC9153;
    cursor: pointer;
    // display: inline-block;
    // margin-left: 5px;
  } 
</style>
