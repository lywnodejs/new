<template>
  <div id="ocean-department-vulnerabilityList">
    <div class="switch">
      <span><span class="switch-title">只看修复中：</span><el-switch v-model="queryParam.is_fixing" :active-value='1' :inactive-value='0'></el-switch></span>&nbsp;&nbsp;&nbsp;
      <span><span  class="switch-title">只看线上：</span><el-switch v-model="queryParam.is_r2" :active-value='1' :inactive-value='0'></el-switch></span>
    </div>
      <div class="table">
          <div class="tableTitle">漏洞列表</div>
          <el-table :header-cell-style="rowClass" :cell-style='cellStyle'
            :data="tableData"
            :border="false"
            style="width: 100%;">
             <el-table-column
                label="漏洞单号"
                width="80"
                align="center">
                <template slot-scope="scope">
                <span>{{scope.row.vul_id}}</span>
                </template>
            </el-table-column>
            <el-table-column
                label="漏洞名称"
                align="center">
                <template slot-scope="scope">
                <span>{{scope.row.vul_name}}</span>
                </template>
            </el-table-column>
            <el-table-column
                label="漏洞等级"
                width="100"
                align="center">
                <template slot-scope="scope">
                <span>{{ handleVul(scope.row.vul_level_id, 'vulLevel') }}</span>
                </template>
            </el-table-column>
            <el-table-column
                label="漏洞状态"
                width="100"
                align="center">
                <template slot-scope="scope">
                <span>{{ handleVul(scope.row.vul_status, 'vulStatus') }}</span>
                </template>
            </el-table-column>
            <el-table-column
                label="漏洞属性"
                width="80"
                align="center">
                <template slot-scope="scope">
                    <el-tag  :class="scope.row.is_r2==0? 'r1':'r2'">{{ scope.row.is_r2==0? 'R1':'R2' }}</el-tag>
                </template>
            </el-table-column>
            <el-table-column
                label="漏洞来源"
                width="150"
                align="center">
                <template slot-scope="scope">
                <span>{{ handleSourceID(scope.row.vul_source2_id)}}</span>
                </template>
            </el-table-column>
            <el-table-column
                label="上报时间"
                width="100"
                align="center">
                <template slot-scope="scope">
                    <span>{{ scope.row.vul_post_time.split(' ')[0]}}</span><br>
                    <span>{{ scope.row.vul_post_time.split(' ')[1]}}</span>
                </template>
            </el-table-column>
            <el-table-column
                label="部门"
                width="160"
                align="center">
                <template slot-scope="scope">
                <span>{{ scope.row.dept_name}}</span>
                </template>
            </el-table-column>
          </el-table>
      </div>
      
    <div align="right" style="margin-top: 10px;margin-right:23px;">
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        @change="fetchData"
        :current-page="queryParam.page"
        :page-sizes="[10,20,30,50]"
        :page-size="queryParam.limit"
        layout="total, sizes, prev, pager, next, jumper"
        :total="num">
      </el-pagination>
    </div>
  </div>
</template>
<script>
  import {connect} from '@/lib'
  import * as CONSTANTS from '@/commons/cachalot'

  export default connect(() => {
    return {
    }
  }, {
    getVulnerabilityList: 'ocean_department/getVulnerabilityList'
  })({
    data() {
      return {
          tableData: [],
          queryParam: {
            dept_id: this.deptId,
            start_date: this.time[0],
            end_date: this.time[1],
            is_fixing: 0,
            is_r2: 0,
            page: 1,
            limit: 10
          },
          num: 0
      }
    },
    props: ['deptId', 'time'],
    created() {
        this.fetchData()
    },
    mounted() {
    },
    watch: {
      'queryParam.is_fixing': {
        handler(val) {
          this.fetchData()
        }
      },
      'queryParam.is_r2': {
        handler(val) {
          this.fetchData()
        }
      }
    },
    methods: {
      fetchData() {
          let queryParam = this.queryParam
          this.queryParam.dept_id = this.deptId
          this.queryParam.start_date = this.time[0]
          this.queryParam.end_date = this.time[1]
          this.getVulnerabilityList(queryParam).then(res => {
              this.num = res.count
            this.tableData = res.vulnerability_list
          })
      },
      rowClass() {
          return 'font-size:10px;background:white;'
      },
      cellStyle({row, column, rowIndex, columnIndex}) {
            return 'font-size:10px;'
      },
      handleSourceID(id) {
          let label = ''
          CONSTANTS.vulSource2Internal.forEach(element => {
              if (element.value == id) {
                  label = element.label
              }
          });
          if (label != '') {
              return label
          }
          CONSTANTS.vulSource2External.forEach(element => {
              if (element.value == id) {
                  label = element.label
              }
          });
          return label
      },
      handleVul(id, type) {
          let label
          CONSTANTS[type].forEach(element => {
              if (element.value == id) {
                  label = element.label
              }
          });
          return label
      },
      handleSizeChange(val) {
        this.queryParam.limit = val
        this.fetchData()
      },
      handleCurrentChange(val) {
        this.queryParam.page = val
        this.fetchData()
      }
    }
  })
</script>

<style lang="less">
#ocean-department-vulnerabilityList{
    background-color: white;
      margin: 23px 23px 10px 23px;
      position: relative;
      padding-bottom: 10px;
      .el-table{
          border: none !important;
      }
      .table{
          margin:0 23px;
          .tableTitle{ 
              padding: 15px 0;
              text-align: left;
              font-size: 12.5px;
          }
      }
      .switch{
        position: absolute;
        font: normal 10px 'Microsoft YaHei', '微软雅黑', arial, helvetica, sans-serif;;
        top: 16px;
        right: 25px;
        .switch-title {
          font-weight: normal;
          color: gray;
        }
        span{
          line-height: 10px;
        }
        
      }
      .r1{
        background-color: rgba(103, 194, 58, 0.1);
        color: #67c23a;
        display: inline-block;
        padding: 0 10px;
        -webkit-font-smoothing: antialiased;
        height: 26px;
        line-height: 23px;
        font-size: 12px;
        border-radius: 4px;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        border: 1px solid rgba(103, 194, 58, 0.2);
        white-space: nowrap;
      }
      .r2{
        background-color: rgba(245, 108, 108, 0.1);
        display: inline-block;
        padding: 0 10px;
        -webkit-font-smoothing: antialiased;
        height: 26px;
        line-height: 23px;
        font-size: 12px;
        color: #f56c6c;
        border-radius: 4px;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        border: 1px solid rgba(245, 108, 108, 0.2);
        white-space: nowrap;
      }
}
</style>

